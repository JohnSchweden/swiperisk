---
phase: 03-polish-performance
plan: 03
type: execute
wave: 2
depends_on:
  - 03-01
  - 03-02
files_modified:
  - index.html
  - App.tsx
autonomous: true
must_haves:
  truths:
    - will-change applied to active swipeable card via .swipe-card class
    - backface-visibility: hidden for GPU acceleration on swipe elements
    - Font smoothing CSS applied for crisp text rendering
    - touch-action: pan-y for passive scroll handling
    - CRT overlay disabled on mobile via media query (performance)
    - Lighthouse performance score ≥ 90
  artifacts:
    - path: index.html
      provides: Performance CSS with will-change and GPU acceleration
      contains: ".swipe-card { will-change: transform, opacity; backface-visibility: hidden; }"
    - path: App.tsx
      provides: swipe-card class applied to active card element
      pattern: "className=\".*swipe-card.*\""
  key_links:
    - from: App.tsx swipe-card class
      to: index.html CSS optimizations
      via: CSS class application
---

<objective>
Optimize touch gesture performance and achieve Lighthouse score ≥ 90. Add missing performance CSS (swipe-card class, font smoothing, touch-action) while acknowledging that will-change already exists on exit animations from Phase 2.

Purpose: Users experience buttery-smooth 60fps swipe interactions. Performance optimizations ensure premium feel without jank or dropped frames, even on mid-range mobile devices.
</objective>

<execution_context>
@/Users/yevgenschweden/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/yevgenschweden/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/03-polish-performance/03-CONTEXT.md
@.planning/phases/03-polish-performance/03-RESEARCH.md

**Current State (from research):**

**ALREADY EXISTS (from Phase 2):**
- ✅ `will-change: transform, opacity` on .swipe-exit-left (index.html line 75)
- ✅ `will-change: transform, opacity` on .swipe-exit-right (index.html line 80)
- ✅ `will-change: transform` on .spring-snap-back (index.html line 86)
- ✅ RAF-optimized touch handlers in App.tsx (lines 409-521)
- ✅ Card stack implementation (next card behind)

**MISSING (needs implementation):**
- ❌ `.swipe-card` class for active card (currently only exit classes exist)
- ❌ Font smoothing CSS (-webkit-font-smoothing)
- ❌ touch-action CSS for passive scroll
- ❌ Mobile media query to disable CRT effect
- ❌ Lighthouse audit to verify ≥ 90 score

**Key insight:** The existing swipe implementation is already well-optimized with RAF and will-change on exit animations. We need to add the missing `.swipe-card` class for the active card and additional CSS optimizations.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add swipe-card performance class to CSS</name>
  <files>index.html</files>
  <action>
Add the `.swipe-card` performance class to the CSS in index.html. Add after the existing swipe-related CSS (around line 100, after the @keyframes definitions):

```css
/* Performance Optimizations for Active Card */
.swipe-card {
    will-change: transform, opacity;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
    transform: translateZ(0); /* Force GPU layer creation */
    touch-action: pan-y; /* Allow vertical scroll, handle horizontal in JS */
}
```

**Important:** This class should ONLY be applied to the active swipeable card, NOT the next card preview. The next card should NOT have will-change to avoid unnecessary GPU memory usage.

The touch-action: pan-y allows the browser to handle vertical scrolling passively while the game handles horizontal swipes in JavaScript.
  </action>
  <verify>
    grep -A 6 "\.swipe-card {" index.html
    grep "will-change: transform, opacity" index.html
    grep "backface-visibility: hidden" index.html
    grep "touch-action: pan-y" index.html
  </verify>
  <done>
    .swipe-card class defined with will-change, backface-visibility, transform: translateZ(0), and touch-action: pan-y
  </done>
</task>

<task type="auto">
  <name>Task 2: Add font smoothing to body CSS</name>
  <files>index.html</files>
  <action>
Update the body CSS (around line 20) to include font smoothing for crisp text rendering.

**Current code:**
```css
body {
    font-family: 'Space Grotesk', sans-serif;
    background-color: #0a0a0c;
    color: #e2e8f0;
    overflow-x: hidden;
}
```

**Change to:**
```css
body {
    font-family: 'Space Grotesk', sans-serif;
    background-color: #0a0a0c;
    color: #e2e8f0;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    text-rendering: optimizeLegibility;
}
```

This improves text rendering quality, especially on macOS and iOS devices.
  </action>
  <verify>
    grep -A 8 "^body {" index.html | grep -E "font-smoothing|text-rendering"
  </verify>
  <done>
    Body CSS includes -webkit-font-smoothing: antialiased, -moz-osx-font-smoothing: grayscale, and text-rendering: optimizeLegibility
  </done>
</task>

<task type="auto">
  <name>Task 3: Disable CRT effect on mobile for performance</name>
  <files>index.html</files>
  <action>
Add a media query to disable the CRT overlay effect on mobile devices to improve performance. Add after the existing mobile media query (around line 330, after the @media (max-width: 768px) block):

```css
/* Disable CRT effect on mobile for performance */
@media (max-width: 768px) {
    body::after {
        display: none;
    }
}
```

The CRT effect uses multiple gradient layers and can impact performance on lower-end mobile devices. Disabling it on mobile (where the effect is less noticeable on small screens anyway) improves frame rates during swipe gestures.
  </action>
  <verify>
    grep -A 4 "Disable CRT effect" index.html
  </verify>
  <done>
    Mobile media query hides body::after (CRT effect) on screens ≤768px
  </done>
</task>

<task type="auto">
  <name>Task 4: Apply swipe-card class to active card in App.tsx</name>
  <files>App.tsx</files>
  <action>
Apply the `swipe-card` class to the active swipeable card element in the renderGame method.

**Locate the card element** (around line 884-909 in renderGame):
The card div with `ref={cardRef}` currently has these classes:
```jsx
className={`relative inset-0 bg-slate-900/90 border border-slate-700 rounded-xl overflow-hidden shadow-2xl flex flex-col select-none ${isFirstCard && !cardExitDirection && !isDragging && !hasDragged ? 'ticket-transition' : ''} ${isSnappingBack ? 'spring-snap-back' : ''}`}
```

**Add swipe-card to the className:**
```jsx
className={`absolute inset-0 bg-slate-900/90 border border-slate-700 rounded-xl overflow-hidden shadow-2xl flex flex-col select-none swipe-card ${isFirstCard && !cardExitDirection && !isDragging && !hasDragged ? 'ticket-transition' : ''} ${isSnappingBack ? 'spring-snap-back' : ''} ${cardExitDirection === 'LEFT' ? 'swipe-exit-left' : cardExitDirection === 'RIGHT' ? 'swipe-exit-right' : ''}`}
```

**Important:** The "next card" preview (lines 843-881) should NOT get the swipe-card class. Only the active card with `ref={cardRef}` should have it.
  </action>
  <verify>
    grep -n "swipe-card" App.tsx
    grep -B 2 -A 2 "ref={cardRef}" App.tsx | grep "className"
  </verify>
  <done>
    swipe-card class applied to the active card element (the one with ref={cardRef})
  </done>
</task>

<task type="auto">
  <name>Task 5: Verify swipe performance with browser</name>
  <files></files>
  <action>
Use agent-browser to verify swipe gestures perform smoothly at 60fps after optimizations.

**Verification steps:**
1. Start dev server: `bun dev`
2. Open http://localhost:3000
3. Navigate through: Intro → Personality → Role → Game
4. In the Game screen, perform swipe gestures:
   - Swipe left and right on cards
   - Test both touch (if testing on mobile) and mouse drag
   - Verify the card follows finger/mouse smoothly
   - Verify the exit animation is smooth
   - Verify the next card appears correctly underneath

**What to check:**
- No jank or stuttering during drag
- Card follows input smoothly (60fps)
- Exit animation plays smoothly
- Spring snap-back feels natural
- No dropped frames visible

**Performance indicators:**
- Animations feel "buttery smooth"
- No visual hitches or freezes
- Touch responsiveness feels immediate

**Commands:**
```bash
# Check if dev server is running
lsof -i :3000 2>/dev/null || echo "Start server: bun dev"

# Browser verification
agent-browser open http://localhost:3000
agent-browser snapshot -i
# Navigate to game screen and test swipes
```
  </action>
  <verify>
    echo "Browser verification: Test swipe performance on game screen"
    echo "- Card should follow finger/mouse smoothly (60fps)"
    echo "- No jank or dropped frames during drag"
    echo "- Exit animations should play smoothly"
    echo "- Spring snap-back should feel natural"
  </verify>
  <done>
    Browser verification confirms swipe gestures run at 60fps without jank
  </done>
</task>

<task type="auto">
  <name>Task 6: Run Lighthouse performance audit</name>
  <files></files>
  <action>
Run a Lighthouse performance audit to verify the optimizations achieve score ≥ 90.

**Prerequisites:**
1. Build production bundle: `bun run build`
2. Serve production build: `bun run preview` or `npx serve dist`

**Option A: Lighthouse CLI (if installed)**
```bash
# Install lighthouse if needed
npm install -g lighthouse

# Run audit
lighthouse http://localhost:4173 \
  --preset=desktop \
  --only-categories=performance \
  --output=json \
  --output-path=lighthouse-report.json \
  --chrome-flags="--headless"
```

**Option B: Manual Chrome DevTools**
1. Start preview server: `bun run preview`
2. Open Chrome to http://localhost:4173
3. Open DevTools → Lighthouse tab
4. Select "Performance" only
5. Click "Analyze page load"
6. Record the score

**Key metrics to achieve:**
- Performance score ≥ 90 ✅
- First Contentful Paint < 1.8s
- Largest Contentful Paint < 2.5s  
- Total Blocking Time < 200ms
- Cumulative Layout Shift < 0.1

**If score < 90:**
- Check for render-blocking resources
- Check for unused JavaScript
- Check bundle size
- Document issues and create follow-up tasks if needed

**Save results:**
```bash
# Save Lighthouse report
cat lighthouse-report.json | jq '.categories.performance.score * 100'
```
  </action>
  <verify>
    # Build and test
    bun run build
    bun run preview &
    sleep 3
    
    # Check if we can get a score
    echo "Lighthouse score target: ≥ 90"
    echo "Check lighthouse-report.json for results"
    
    # Cleanup
    pkill -f "bun run preview" 2>/dev/null || true
  </verify>
  <done>
    Lighthouse audit completed with performance score ≥ 90 (or documented path to achieve it)
  </done>
</task>

<task type="auto">
  <name>Task 7: Run Playwright performance tests</name>
  <files>tests/</files>
  <action>
Run Playwright tests to verify no regressions and that interactions remain performant.

**Test command:**
```bash
# Run specific interaction tests if they exist
npx playwright test --project=chromium --grep "swipe\|performance\|game"

# Or run all tests
bun run test
```

**What to verify:**
- All game screen tests pass
- Swipe interactions work correctly
- No console errors related to performance
- No new warnings about passive event listeners

**If tests fail:**
- Review test logs for performance-related errors
- Check if touch-action CSS caused any issues
- Verify will-change doesn't break anything
  </action>
  <verify>
    bun run test 2>&1 | tail -30
    echo "Verify all tests pass, especially game screen and interaction tests"
  </verify>
  <done>
    All Playwright tests pass, no performance-related regressions
  </done>
</task>

</tasks>

<verification>
1. index.html contains `.swipe-card` class with:
   - will-change: transform, opacity ✅
   - backface-visibility: hidden ✅
   - transform: translateZ(0) ✅
   - touch-action: pan-y ✅
2. Body CSS includes font-smoothing ✅
3. Mobile media query disables CRT effect ✅
4. App.tsx active card has `swipe-card` class ✅
5. Next card (preview) does NOT have swipe-card class ✅
6. Browser test confirms 60fps swipe performance ✅
7. Lighthouse performance score ≥ 90 ✅
8. All Playwright tests pass ✅
</verification>

<success_criteria>
- will-change: transform, opacity applied to active swipeable card via .swipe-card class
- backface-visibility: hidden for GPU acceleration
- -webkit-font-smoothing: antialiased for crisp text rendering
- touch-action: pan-y for passive scroll handling
- CRT overlay disabled on mobile via media query
- Lighthouse performance score ≥ 90
- Touch gestures maintain 60fps during swipe
- No Playwright test regressions
</success_criteria>

<output>
After completion, create `.planning/phases/03-polish-performance/03-03-SUMMARY.md`
</output>
